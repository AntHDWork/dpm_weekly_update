name: Combine weekly updates

on:
  workflow_dispatch:
    inputs:
      week:
        description: 'Week ending (YYYY-MM-DD), e.g. 2025-10-31'
        required: false
        type: string
  push:
    paths:
      - 'data/**'
      - 'tools/**'
      - 'schemas/**'
      - '.github/workflows/combine.yml'

jobs:
  combine:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GPT_API_KEY: ${{ secrets.GPT_API_KEY }}
      GPT_ENDPOINT: ${{ secrets.GPT_ENDPOINT }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Fallback week detection from changed paths (only used if no manual input)
      - name: Determine changed week folder (fallback)
        id: week
        run: |
          set -euo pipefail
          # Find the first changed path under data/, extract the week folder (2nd segment)
          CHANGES="$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" | grep '^data/' || true)"
          if [ -n "$CHANGES" ]; then
            WEEK="$(echo "$CHANGES" | head -n1 | cut -d/ -f2)"
            echo "week=$WEEK" >> "$GITHUB_OUTPUT"
            echo "Auto-detected week: $WEEK"
          else
            echo "week=" >> "$GITHUB_OUTPUT"
            echo "No changes under data/, week not auto-detected."
          fi

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Print Node & npm versions
        run: |
          node -v
          npm -v

      # Install only if there's something to install
      - name: Install deps (if present)
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            echo "Using npm ci"
            npm ci
          elif [ -f package.json ]; then
            echo "Using npm install (no lockfile)"
            npm install --no-audit --no-fund
          else
            echo "No package.json found — skipping install."
          fi

      - name: Run combiner
        env:
          WEEK_INPUT: ${{ github.event.inputs.week }}
          WEEK_FALLBACK: ${{ steps.week.outputs.week }}
        run: |
          set -euo pipefail
          WEEK="${WEEK_INPUT:-$WEEK_FALLBACK}"
          if [ -z "${WEEK:-}" ]; then
            echo "❌ No week provided and could not auto-detect from changes."
            exit 1
          fi
          echo "✅ Using week: $WEEK"
          node tools/combine.mjs "$WEEK"
